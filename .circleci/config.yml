---
version: 2.1

orbs:
  slack: circleci/slack@volatile
  circle-compare-url: iynere/compare-url@0.1.0

executors:
  cli:
    docker:
      - image: circleci/circleci-cli:0.1.2709

workflows:
  version: 2
  main:
    jobs:
      - lint
      - build
      - dev-release:
          requires: [build, lint]

      - hold:
          type: approval
          filters:
            branches:
              only: master
      - dev-promote-patch:
          requires: [hold]

jobs:
  lint:
    docker: [image: singapore/lint-condo]
    steps:
      - checkout
      - run:
          'yamllint -c yamllint.yaml .'
  build:
    executor: cli
    steps:
      - checkout
      - run:
          name: Validate Orbs
          command: "sh scripts/validate-orbs.sh"
  dev-release:
    executor: cli
    steps:
      - checkout
      - circle-compare-url/reconstruct
      - run:
          name: Publish dev releases of any modified orbs
          command: .scripts/publish_orbs.sh dev_release

  dev-promote-patch:
    executor: cli
    steps:
      - checkout
      - circle-compare-url/reconstruct
      - run:
          name: Publish any modified orbs
          command: scripts/publish.sh patch_release
